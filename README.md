# OS/mosis
**A freestanding 32-bit x86 kernel seed that refuses to be vagueâ€”and aims to feel inevitable.**

[![Target](https://img.shields.io/badge/arch-i386%2032--bit-353535?labelColor=111)](manifesto.md)
[![Focus](https://img.shields.io/badge/Correctness-First-success?labelColor=111)](manifesto.md)
[![Clarity](https://img.shields.io/badge/Clarity-Always-blue?labelColor=111)](manifesto.md)
[![Roadmap](https://img.shields.io/badge/Finish%20Line-Boot%20to%20Shell-orange?labelColor=111)](STRUCTURE.md)

OS/mosis is one stackâ€”boot sector to shellâ€”designed to stay understandable while it grows. The kernel is freestanding, interrupt-driven, and organized so every boundary is explicit, documented, and auditable. The tone is deliberate: logs teach, panics explain, and every phase is charted.

Boot previews (boot log + GIF) are generated by the [boot-preview workflow](.github/workflows/boot-gif.yml); grab the artifacts from the latest run when you want a glimpse without building locally.

## Why this project exists
- **Correctness first, clarity always.** When the system fails, it halts loudly; when it runs, the path is explainable.
- **Freestanding on purpose.** No hidden libc; every runtime assumption is written down and tested.
- **One contract.** Kernel and future userland evolve together with documented ABIs and minimal surfaces.

Read the expanded [Manifesto](manifesto.md) for the full oath, the tone, and the promises we will not break.

## Directory overview
- `src/arch/i386/boot/boot.asm` â€” Stage-0 entry that switches to protected mode and jumps to the kernel.
- `src/arch/i386/gdt.asm` â€” Global Descriptor Table definition used during the mode switch.
- `src/arch/i386/idt.c` â€” Interrupt Descriptor Table setup and helpers for exception vectors 0â€“31.
- `src/arch/i386/isr.asm`, `src/arch/i386/isr_handler.c` â€” ISR stubs and C handler that print exception context and halt safely.
- `src/arch/i386/irq.asm`, `src/arch/i386/irq.c` â€” PIC remap, IRQ stubs (32â€“47), and a basic handler/registration layer.
- `src/arch/i386/pit.c` â€” PIT configuration, tick counter, and timing helpers.
- `src/arch/i386/keyboard.c` â€” PS/2 keyboard IRQ handler and printable scancode mapping.
- `src/kernel/` â€” Console, formatting, panic handling, shell glue, and physical memory management.
- `include/osmosis/` â€” Public headers for kernel subsystems; architecture-specific headers live under `include/osmosis/arch/i386`.
- `build/linker.ld` â€” Linker script that places the kernel at 0x0010_0000.
- `build/obj/` â€” Generated object files (created during the build).
- `docs/` â€” Roadmap, structure, and rules for kernel/userland integration.

### Legacy files
The repository root still contains the earliest single-file kernel artifacts (`boot.asm`, `gdt.asm`, `kernel.c`, `idt.c`, etc.) and a preserved snapshot under `legacy/osmosis_repo/`. They remain for comparison and teaching; the active build uses the `src/` + `include/` layout above.

## Quick start
Build with a cross i686-elf toolchain (`nasm`, `i686-elf-gcc`, `i686-elf-ld`) by setting `CROSS=i686-elf-`:

```bash
make CROSS=i686-elf-
```

On a host toolchain, install `nasm` plus 32-bit development support (e.g., `gcc-multilib` on Debian/Ubuntu), then:

```bash
make            # builds build/kernel.bin
```

Artifacts are written under `build/`.

## Run in QEMU (headless)
```bash
make qemu
```

The `qemu` target enables serial logging (`-serial stdio`) and uses QEMU's `isa-debug-exit` port so the VM exits cleanly once the kernel finishes boot messaging. If `qemu-system-i386` is missing, `scripts/qemu.sh` will install `qemu-system-x86` on Debian/Ubuntu hosts (set `OSMOSIS_QEMU_AUTO_INSTALL=0` to skip auto-install, or point to an existing binary with `QEMU_BIN=/path/to/qemu-system-i386`).

## Roadmap snapshot
- âœ… Phase A (exceptions) and B1 (PIC remap + IRQ routing) are in place.
- âœ… PIT heartbeat (B2) at 100 Hz proves interrupts stay alive.
- âœ… Keyboard IRQ handling (B3) buffers input for the kernel shell.
- ðŸ”œ Next: deepen timer stress tests and shape shell input paths on the new buffer.

## Organization principles
- Architecture-specific code is contained under `src/arch/i386` with matching headers in `include/osmosis/arch/i386`.
- Common kernel components live under `src/kernel` and include headers from `include/osmosis`.
- The `Makefile` drives the freestanding build and keeps generated objects in `build/obj/` so the source tree stays clean.
